"use strict";(()=>{var e={};e.id=600,e.ids=[600],e.modules={1594:e=>{e.exports=require("hebece")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,o)=>{Object.defineProperty(o,"l",{enumerable:!0,get:function(){return function e(o,t){return t in o?o[t]:"then"in o&&"function"==typeof o.then?o.then(o=>e(o,t)):"function"==typeof o&&"default"===t?o:void 0}}})},9517:(e,o,t)=>{t.r(o),t.d(o,{config:()=>c,default:()=>P,routeModule:()=>I});var r={};t.r(r),t.d(r,{default:()=>A});var n=t(1802),s=t(7153),l=t(6249),a=t(890);async function i(e,o){try{console.log("[API DEBUG] Lessons API called with query:",e.query),console.log("[API DEBUG] Checking APIAP states:",{globalState:global.__APIAP__?`Found with length ${global.__APIAP__.length}`:"Not found",processEnvState:process.env.RUNTIME_APIAP?`Found with length ${process.env.RUNTIME_APIAP.length}`:"Not found"});let{startDate:t,endDate:r}=e.query;if(!t||!r)return console.error("[API DEBUG] Missing required parameters startDate or endDate"),o.status(400).json({error:"Требуются параметры startDate и endDate"});let n=0;for(;n<2;)try{console.log(`[API DEBUG] Fetching lessons for date range: ${t} to ${r} (Attempt ${n+1}/2)`);let e=await (0,a.tj)(t,r);return e&&Array.isArray(e)?(console.log(`[API DEBUG] Received ${e.length} lessons`),e.length>0&&console.log("[API DEBUG] Sample lesson:",e[0])):console.log("[API DEBUG] Unexpected response format:",e),o.status(200).json(e)}catch(o){console.error(`[API DEBUG] Error in lessons API (Attempt ${n+1}/2):`,o);let e=o instanceof Error?o.message:String(o);(e.includes("No valid API key")||e.includes("API key not found")||e.includes("Failed to connect to Vulcan API"))&&(console.log("[API DEBUG] API key error detected, retrying with fresh global/process state sync"),!global.__APIAP__&&process.env.RUNTIME_APIAP&&(console.log("[API DEBUG] Restoring global.__APIAP__ from process.env.RUNTIME_APIAP"),global.__APIAP__=process.env.RUNTIME_APIAP),global.__APIAP__&&!process.env.RUNTIME_APIAP&&(console.log("[API DEBUG] Restoring process.env.RUNTIME_APIAP from global.__APIAP__"),process.env.RUNTIME_APIAP=global.__APIAP__)),++n<2&&(console.log("[API DEBUG] Waiting 1 second before retry..."),await new Promise(e=>setTimeout(e,1e3)))}return console.error("[API DEBUG] All retry attempts failed"),o.status(500).json({error:"Ошибка при получении данных о расписании. Пожалуйста, выйдите из системы и войдите снова."})}catch(e){return console.error("[API DEBUG] Unhandled error in lessons API:",e),o.status(500).json({error:"Ошибка при получении данных о расписании. Пожалуйста, попробуйте еще раз."})}}let A=(0,t(5342).Y)(i),P=(0,l.l)(r,"default"),c=(0,l.l)(r,"config"),I=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/vulcan/lessons",pathname:"/api/vulcan/lessons",bundlePath:"",filename:""},userland:r})},890:(e,o,t)=>{let r,n,s;t.d(o,{G5:()=>a,ZN:()=>I,_P:()=>P,bh:()=>g,gq:()=>d,tj:()=>A,w7:()=>c});let l=async()=>{try{let e=await Promise.resolve().then(t.t.bind(t,1594,23));return r=e.Keypair,n=e.VulcanJwtRegister,s=e.VulcanHebeCe,!0}catch(e){console.error("Failed to import hebece module:",e)}return!1};l().catch(e=>{console.error("Failed to initialize server modules:",e)});let a=e=>{e&&(console.log("Setting server-side APIAP cache"),global.__APIAP__=e,process.env.RUNTIME_APIAP=e,console.log("APIAP stored in both global state and process.env"))};(e=>{if(e)try{if(e.startsWith("<html>"))return e;let o={};if(e.trim().startsWith("{"))try{o=JSON.parse(e)}catch(e){console.error("Failed to parse APIAP as JSON:",e)}else{let t=e.match(/<input id="ap" type="hidden" value="(.*?)"><\/body>/);if(t&&t[1]){let e=t[1].replace(/&quot;/g,'"');try{o=JSON.parse(e)}catch(e){console.error("Failed to parse extracted HTML value as JSON:",e)}}}return`<html><head></head><body><input id="ap" type="hidden" value='${JSON.stringify(o)}' /></body></html>`}catch(e){return console.error("Error formatting APIAP string:",e),null}})(process.env.RUNTIME_APIAP?(console.log("Using APIAP from process.env"),global.__APIAP__=process.env.RUNTIME_APIAP,process.env.RUNTIME_APIAP):global.__APIAP__?(console.log("Using server-side cached APIAP from global state"),process.env.RUNTIME_APIAP=global.__APIAP__,global.__APIAP__):(console.warn("No APIAP available on server without explicit configuration"),null));let i=async()=>{let e=process.env.RUNTIME_APIAP||global.__APIAP__;if(console.log("[API CLIENT] APIAP state check:",e?`APIAP found with length: ${e.length}`:"No APIAP found in available state"),!e)throw console.error("No valid APIAP string available. Cannot initialize Vulcan API."),console.log("[API CLIENT] Available global properties:",Object.keys(global).join(", ")),Error("No valid API key found. Please authenticate first.");try{if((!r||!n||!s)&&(console.log("[API CLIENT] Initializing server modules..."),!await l()))throw Error("Failed to initialize required modules");console.log("[API CLIENT] Using server-side APIAP for API initialization...");let o=await new r().init();console.log("[API CLIENT] Keypair initialized, creating JWT register with APIAP...");let t=await new n(o,e,0).init();console.log("[API CLIENT] JWT register successful, RestURL:",t.Envelope.RestURL);let a=new s(o,t.Envelope.RestURL);return console.log("[API CLIENT] Connecting HebeCe..."),await a.connect(),console.log("[API CLIENT] HebeCe connected successfully"),global.__APIAP__=e,process.env.RUNTIME_APIAP=e,a}catch(e){throw console.error("[API CLIENT] Failed to initialize Vulcan API:",e),Error("Failed to connect to Vulcan API")}},A=async(e,o)=>{try{let t=await i(),r=new Date(e),n=new Date(o);return(await t.getLessons(r,n)).Envelope||[]}catch(e){throw console.error("Error fetching lessons:",e),e}},P=async(e,o)=>{try{let t=await i(),r=new Date(e),n=new Date(o);return(await t.getExams(r,n)).Envelope||[]}catch(e){throw console.error("Error fetching exams:",e),e}},c=async(e,o)=>{try{let t=await i(),r=new Date(e),n=new Date(o);return(await t.getAttendance(r,n)).Envelope||[]}catch(e){throw console.error("Error fetching attendance:",e),e}},I=async()=>{try{let e=await i();return(await e.getGrades()).Envelope||[]}catch(e){throw console.error("Error fetching grades:",e),e}},g=async(e,o)=>{try{console.log(`[API CLIENT DEBUG] getHomework called with dates: ${e} to ${o}`);let t=await i(),r=new Date(e),n=new Date(o);console.log(`[API CLIENT DEBUG] Parsed dates: ${r.toISOString()} to ${n.toISOString()}`),console.log("[API CLIENT DEBUG] Calling hebe.getHomework...");let s=await t.getHomework(r,n);if(console.log("[API CLIENT DEBUG] Raw API response:",s),s&&s.Envelope)return console.log(`[API CLIENT DEBUG] Found Envelope with ${Array.isArray(s.Envelope)?s.Envelope.length:"non-array"} items`),s.Envelope||[];if(s&&Array.isArray(s))return console.log(`[API CLIENT DEBUG] Found array with ${s.length} items`),s;return console.log("[API CLIENT DEBUG] Unexpected data structure:",s),[]}catch(e){throw console.error("[API CLIENT DEBUG] Error fetching homework:",e),e}},d=async(e,o)=>{try{console.log(`[API CLIENT DEBUG] getChangedLessons called with dates: ${e} to ${o}`);let t=await i(),r=new Date(e),n=new Date(o);console.log(`[API CLIENT DEBUG] Parsed dates for substitutions: ${r.toISOString()} to ${n.toISOString()}`),console.log("[API CLIENT DEBUG] Calling hebe.getChangedLessons...");let s=await t.getChangedLessons(r,n);if(console.log("[API CLIENT DEBUG] Raw API response for substitutions:",s),s&&s.Envelope)return console.log(`[API CLIENT DEBUG] Found Envelope with ${Array.isArray(s.Envelope)?s.Envelope.length:"non-array"} substitutions`),s.Envelope||[];if(s&&Array.isArray(s))return console.log(`[API CLIENT DEBUG] Found array with ${s.length} substitutions`),s;return console.log("[API CLIENT DEBUG] Unexpected data structure for substitutions:",s),[]}catch(e){throw console.error("[API CLIENT DEBUG] Error fetching substitutions:",e),e}}},5342:(e,o,t)=>{t.d(o,{Y:()=>s});var r=t(890);let n=e=>{try{if(e.startsWith("<html>"))return e;let o={};if(e.trim().startsWith("{"))o=JSON.parse(e);else{let t=e.match(/<input id="ap" type="hidden" value="(.*?)"><\/body>/);if(t&&t[1]){let e=t[1].replace(/&quot;/g,'"');o=JSON.parse(e)}}return`<html><head></head><body><input id="ap" type="hidden" value='${JSON.stringify(o)}' /></body></html>`}catch(e){throw console.error("[API CONFIG] Failed to format APIAP string:",e),Error("Invalid APIAP string format")}},s=e=>async(o,t)=>{try{let s;for(let e of Object.keys(o.headers))if("x-apiap"===e.toLowerCase()){let t=o.headers[e];void 0!==t&&(s=Array.isArray(t)?t[0]:t);break}if(s){console.log("[API CONFIG] APIAP provided in request header with length:",s.length);try{let e=n(s);console.log("[API CONFIG] Successfully formatted APIAP string"),global.__APIAP__=e,process.env.RUNTIME_APIAP=e,console.log("[API CONFIG] APIAP stored in both global and process.env")}catch(e){return console.error("[API CONFIG] Failed to process APIAP from header:",e),t.status(401).json({error:"Invalid APIAP string format"})}}else if(global.__APIAP__)console.log("[API CONFIG] Using existing server-side APIAP from global state with length:",global.__APIAP__.length),process.env.RUNTIME_APIAP=global.__APIAP__;else{if(!process.env.RUNTIME_APIAP)return console.log("[API CONFIG] No APIAP available in headers, global state, or process.env"),console.log("[API CONFIG] Available headers:",Object.keys(o.headers).join(", ")),t.status(401).json({error:"No valid API key found. Please authenticate first."});console.log("[API CONFIG] Using existing server-side APIAP from process.env with length:",process.env.RUNTIME_APIAP.length),global.__APIAP__=process.env.RUNTIME_APIAP}return global.__APIAP__&&(0,r.G5)(global.__APIAP__),e(o,t)}catch(e){return console.error("[API CONFIG] Error in API configuration:",e),t.status(500).json({error:"Internal server error in API configuration"})}}},7153:(e,o)=>{var t;Object.defineProperty(o,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,o,t)=>{e.exports=t(145)}};var o=require("../../../webpack-api-runtime.js");o.C(e);var t=o(o.s=9517);module.exports=t})();