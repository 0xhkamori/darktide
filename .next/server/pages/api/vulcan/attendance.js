"use strict";(()=>{var e={};e.id=479,e.ids=[479],e.modules={1594:e=>{e.exports=require("hebece")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},3275:(e,t,r)=>{r.r(t),r.d(t,{config:()=>A,default:()=>P,routeModule:()=>I});var o={};r.r(o),r.d(o,{default:()=>c});var n=r(1802),a=r(7153),l=r(6249),s=r(890);async function i(e,t){try{let{startDate:r,endDate:o}=e.query;if(!r||!o)return t.status(400).json({error:"Требуются параметры startDate и endDate"});let n=await (0,s.w7)(r,o);return t.status(200).json(n)}catch(e){return console.error("Error in attendance API:",e),t.status(500).json({error:"Ошибка при получении данных о посещаемости"})}}let c=(0,r(5342).Y)(i),P=(0,l.l)(o,"default"),A=(0,l.l)(o,"config"),I=new n.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/vulcan/attendance",pathname:"/api/vulcan/attendance",bundlePath:"",filename:""},userland:o})},890:(e,t,r)=>{let o,n,a;r.d(t,{G5:()=>s,ZN:()=>I,_P:()=>P,bh:()=>d,tj:()=>c,w7:()=>A});let l=async()=>{try{let e=await Promise.resolve().then(r.t.bind(r,1594,23));return o=e.Keypair,n=e.VulcanJwtRegister,a=e.VulcanHebeCe,!0}catch(e){console.error("Failed to import hebece module:",e)}return!1};l().catch(e=>{console.error("Failed to initialize server modules:",e)});let s=e=>{e&&(console.log("Setting server-side APIAP cache"),global.__APIAP__=e,process.env.RUNTIME_APIAP=e,console.log("APIAP stored in both global state and process.env"))};(e=>{if(e)try{if(e.startsWith("<html>"))return e;let t={};if(e.trim().startsWith("{"))try{t=JSON.parse(e)}catch(e){console.error("Failed to parse APIAP as JSON:",e)}else{let r=e.match(/<input id="ap" type="hidden" value="(.*?)"><\/body>/);if(r&&r[1]){let e=r[1].replace(/&quot;/g,'"');try{t=JSON.parse(e)}catch(e){console.error("Failed to parse extracted HTML value as JSON:",e)}}}return`<html><head></head><body><input id="ap" type="hidden" value='${JSON.stringify(t)}' /></body></html>`}catch(e){return console.error("Error formatting APIAP string:",e),null}})(process.env.RUNTIME_APIAP?(console.log("Using APIAP from process.env"),global.__APIAP__=process.env.RUNTIME_APIAP,process.env.RUNTIME_APIAP):global.__APIAP__?(console.log("Using server-side cached APIAP from global state"),process.env.RUNTIME_APIAP=global.__APIAP__,global.__APIAP__):(console.warn("No APIAP available on server without explicit configuration"),null));let i=async()=>{let e=process.env.RUNTIME_APIAP||global.__APIAP__;if(console.log("[API CLIENT] APIAP state check:",e?`APIAP found with length: ${e.length}`:"No APIAP found in available state"),!e)throw console.error("No valid APIAP string available. Cannot initialize Vulcan API."),console.log("[API CLIENT] Available global properties:",Object.keys(global).join(", ")),Error("No valid API key found. Please authenticate first.");try{if((!o||!n||!a)&&(console.log("[API CLIENT] Initializing server modules..."),!await l()))throw Error("Failed to initialize required modules");console.log("[API CLIENT] Using server-side APIAP for API initialization...");let t=await new o().init();console.log("[API CLIENT] Keypair initialized, creating JWT register with APIAP...");let r=await new n(t,e,0).init();console.log("[API CLIENT] JWT register successful, RestURL:",r.Envelope.RestURL);let s=new a(t,r.Envelope.RestURL);return console.log("[API CLIENT] Connecting HebeCe..."),await s.connect(),console.log("[API CLIENT] HebeCe connected successfully"),global.__APIAP__=e,process.env.RUNTIME_APIAP=e,s}catch(e){throw console.error("[API CLIENT] Failed to initialize Vulcan API:",e),Error("Failed to connect to Vulcan API")}},c=async(e,t)=>{try{let r=await i(),o=new Date(e),n=new Date(t);return(await r.getLessons(o,n)).Envelope||[]}catch(e){throw console.error("Error fetching lessons:",e),e}},P=async(e,t)=>{try{let r=await i(),o=new Date(e),n=new Date(t);return(await r.getExams(o,n)).Envelope||[]}catch(e){throw console.error("Error fetching exams:",e),e}},A=async(e,t)=>{try{let r=await i(),o=new Date(e),n=new Date(t);return(await r.getAttendance(o,n)).Envelope||[]}catch(e){throw console.error("Error fetching attendance:",e),e}},I=async()=>{try{let e=await i();return(await e.getGrades()).Envelope||[]}catch(e){throw console.error("Error fetching grades:",e),e}},d=async(e,t)=>{try{console.log(`[API CLIENT DEBUG] getHomework called with dates: ${e} to ${t}`);let r=await i(),o=new Date(e),n=new Date(t);console.log(`[API CLIENT DEBUG] Parsed dates: ${o.toISOString()} to ${n.toISOString()}`),console.log("[API CLIENT DEBUG] Calling hebe.getHomework...");let a=await r.getHomework(o,n);if(console.log("[API CLIENT DEBUG] Raw API response:",a),a&&a.Envelope)return console.log(`[API CLIENT DEBUG] Found Envelope with ${Array.isArray(a.Envelope)?a.Envelope.length:"non-array"} items`),a.Envelope||[];if(a&&Array.isArray(a))return console.log(`[API CLIENT DEBUG] Found array with ${a.length} items`),a;return console.log("[API CLIENT DEBUG] Unexpected data structure:",a),[]}catch(e){throw console.error("[API CLIENT DEBUG] Error fetching homework:",e),e}}},5342:(e,t,r)=>{r.d(t,{Y:()=>a});var o=r(890);let n=e=>{try{if(e.startsWith("<html>"))return e;let t={};if(e.trim().startsWith("{"))t=JSON.parse(e);else{let r=e.match(/<input id="ap" type="hidden" value="(.*?)"><\/body>/);if(r&&r[1]){let e=r[1].replace(/&quot;/g,'"');t=JSON.parse(e)}}return`<html><head></head><body><input id="ap" type="hidden" value='${JSON.stringify(t)}' /></body></html>`}catch(e){throw console.error("[API CONFIG] Failed to format APIAP string:",e),Error("Invalid APIAP string format")}},a=e=>async(t,r)=>{try{let a;for(let e of Object.keys(t.headers))if("x-apiap"===e.toLowerCase()){let r=t.headers[e];void 0!==r&&(a=Array.isArray(r)?r[0]:r);break}if(a){console.log("[API CONFIG] APIAP provided in request header with length:",a.length);try{let e=n(a);console.log("[API CONFIG] Successfully formatted APIAP string"),global.__APIAP__=e,process.env.RUNTIME_APIAP=e,console.log("[API CONFIG] APIAP stored in both global and process.env")}catch(e){return console.error("[API CONFIG] Failed to process APIAP from header:",e),r.status(401).json({error:"Invalid APIAP string format"})}}else if(global.__APIAP__)console.log("[API CONFIG] Using existing server-side APIAP from global state with length:",global.__APIAP__.length),process.env.RUNTIME_APIAP=global.__APIAP__;else{if(!process.env.RUNTIME_APIAP)return console.log("[API CONFIG] No APIAP available in headers, global state, or process.env"),console.log("[API CONFIG] Available headers:",Object.keys(t.headers).join(", ")),r.status(401).json({error:"No valid API key found. Please authenticate first."});console.log("[API CONFIG] Using existing server-side APIAP from process.env with length:",process.env.RUNTIME_APIAP.length),global.__APIAP__=process.env.RUNTIME_APIAP}return global.__APIAP__&&(0,o.G5)(global.__APIAP__),e(t,r)}catch(e){return console.error("[API CONFIG] Error in API configuration:",e),r.status(500).json({error:"Internal server error in API configuration"})}}},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=3275);module.exports=r})();